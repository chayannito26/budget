<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Budget Dashboard for tracking income, expenses, and budget allocations.">
    <meta name="keywords" content="budget, dashboard, income, expenses, finance">
    <meta name="author" content="Budget Tracker">
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://chayannito26.github.io/budget/dashboard.html">
    <meta property="og:title" content="Budget Dashboard">
    <meta property="og:description" content="Budget Dashboard for tracking income, expenses, and budget allocations.">
    <meta property="og:image" content="https://chayannito26.github.io/budget/dashboard-preview.png">
    <meta property="og:site_name" content="Budget Dashboard">
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://chayannito26.github.io/budget/dashboard.html">
    <meta property="twitter:title" content="Budget Dashboard">
    <meta property="twitter:description" content="Budget Dashboard for tracking income, expenses, and budget allocations.">
    <meta property="twitter:image" content="https://chayannito26.github.io/budget/dashboard-preview.png">
    <title>Budget Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 1.5rem;
        }
        .progress {
            height: 25px;
            font-size: 0.8rem;
        }
        .progress-bar {
            color: #000;
            font-weight: bold;
        }
    /* Slightly deeper custom progress bar colors for better contrast with black text */
    .progress-bar.bg-soft-danger { background-color: #ff9b9b; }
    .progress-bar.bg-soft-warning { background-color: #ffd591; }
    .progress-bar.bg-soft-info { background-color: #9fd6ff; }
    .progress-bar.bg-soft-success { background-color: #b9f0c9; }
    /* Purple-ish color for exactly 100% progress */
    .progress-bar.bg-soft-overflow { background-color: #b893ff; }
        .table-responsive {
            margin-top: 2rem;
        }
        .card-title {
            font-weight: bold;
        }
        .summary-card .card-body {
            text-align: center;
        }
        .summary-card .display-4 {
            font-weight: bold;
        }
        .negative {
            color: #dc3545;
        }
        .positive {
            color: #198754;
        }

        /* Participant Calculator Styles */
        .participant-calculator {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .participant-calculator h5 {
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .participant-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .slider-container {
            flex-grow: 1;
            min-width: 200px;
        }
        .slider-container input[type="range"] {
            width: 100%;
        }
        .participant-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .participant-input-wrapper label {
            margin: 0;
            font-weight: 600;
        }
        .participant-input-wrapper input[type="number"] {
            width: 100px;
            text-align: center;
        }

        /* Sponsorship Modal Styles */
        .modal-lg {
            max-width: 80%;
        }
        .sponsorship-dashboard-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .sponsorship-counter-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            flex-grow: 1;
        }
        .sponsorship-counter-card h2 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            color: #555;
        }
        .sponsorship-counter-card p {
            margin: 10px 0 5px 0;
            font-size: 2.2em;
            font-weight: bold;
            color: #1a1a1a;
        }
        .sponsorship-counter-card span {
            font-size: 1em;
            color: #555;
        }
        .sponsorship-tables {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .sponsorship-category {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .sponsorship-category h2 {
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            #sponsorshipModal .modal-dialog {
                max-width: 100%;
                margin: 0;
            }
            #sponsorshipModal .modal-content {
                min-height: 100vh;
                border-radius: 0;
            }
            .container { padding-top: 1rem; padding-bottom: 1rem; }
            h1 { font-size: 1.75rem; margin-bottom: 1.5rem; }
            .card { margin-bottom: 1rem; }
            .card-body { padding: 1rem; }
            .table-responsive { margin-top: 1rem; }
            .table th, .table td { padding: 0.5rem; font-size: 0.9rem; }
            .progress { height: 20px; font-size: 0.75rem; }
        }

        @media (max-width: 480px) {
            .container { padding-top: 0.5rem; padding-bottom: 0.5rem; }
            h1 { font-size: 1.5rem; margin-bottom: 1rem; }
            .card { margin-bottom: 0.75rem; }
            .card-body { padding: 0.75rem; }
            .card-title { font-size: 1.1rem; }
            .display-4 { font-size: 1.75rem; }
            .table th, .table td { padding: 0.4rem 0.3rem; font-size: 0.8rem; }
            .progress { height: 18px; font-size: 0.7rem; }
            .table-responsive { margin-top: 0.75rem; }
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="text-center mb-5">Budget Dashboard</h1>

        <div class="row" id="summary-cards">
            <!-- Summary cards will be injected here -->
        </div>

        <!-- Participant Calculator -->
        <div class="participant-calculator">
            <h5>Adjust for Number of Participants (<span id="participant-count">200</span>)</h5>
            <div class="participant-controls">
                <div class="slider-container">
                    <input type="range" class="form-range" min="100" max="500" value="200" id="participant-slider" aria-label="Number of participants slider">
                </div>
                <div class="participant-input-wrapper">
                    <label for="participant-input">Participants:</label>
                    <input type="number" class="form-control" min="100" max="500" value="200" id="participant-input" aria-label="Number of participants input">
                </div>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sponsorshipModal">
                View Sponsorship Dashboard
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Category</th>
                        <th>Budgeted</th>
                        <th>Spent</th>
                        <th>Remaining</th>
                        <th>Progress</th>
                    </tr>
                </thead>
                <tbody id="budget-table-body">
                    <!-- Budget details will be injected here -->
                </tbody>
                <tfoot class="table-dark">
                    <tr id="table-footer">
                        <!-- Footer totals will be injected here -->
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Sponsorship Modal -->
    <div class="modal fade" id="sponsorshipModal" tabindex="-1" aria-labelledby="sponsorshipModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sponsorshipModalLabel">Sponsorship Dashboard</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="sponsorship-dashboard-container">
                        <div class="sponsorship-counter-card">
                            <h2>Received</h2>
                            <p id="received-count">0</p>
                            <span id="received-amount">$0</span>
                        </div>
                        <div class="sponsorship-counter-card">
                            <h2>Approached</h2>
                            <p id="approached-count">0</p>
                            <span id="approached-amount">$0</span>
                        </div>
                        <div class="sponsorship-counter-card">
                            <h2>To Be Approached</h2>
                            <p id="to-be-approached-count">0</p>
                            <span id="to-be-approached-amount">$0</span>
                        </div>
                        <div class="sponsorship-counter-card">
                            <h2>Pending</h2>
                            <p id="pending-count">0</p>
                            <span id="pending-amount">$0</span>
                        </div>
                    </div>
                    <div class="sponsorship-tables">
                        <div class="sponsorship-category">
                            <h2>Received</h2>
                            <table class="table" id="received-table">
                                <thead>
                                    <tr>
                                        <th>Sponsor</th>
                                        <th>Amount</th>
                                        <th>Liaison</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="sponsorship-category">
                            <h2>Approached</h2>
                            <table class="table" id="approached-table">
                                <thead>
                                    <tr>
                                        <th>Sponsor</th>
                                        <th>Amount</th>
                                        <th>Liaison</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="sponsorship-category">
                            <h2>To Be Approached</h2>
                            <table class="table" id="to-be-approached-table">
                                <thead>
                                    <tr>
                                        <th>Sponsor</th>
                                        <th>Amount</th>
                                        <th>Liaison</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const budgetUrl = 'https://raw.githubusercontent.com/chayannito26/budget/refs/heads/main/budget-data.json';
            const expensesUrl = 'https://raw.githubusercontent.com/chayannito26/expenses/refs/heads/main/expenses.json';
            const incomeUrl = 'https://raw.githubusercontent.com/chayannito26/income/refs/heads/main/revenues.json';

            let originalBudgetData = [];
            let currentBudgetData = [];
            let expensesData = {};
            let totalIncome = 0;

            const participantSlider = document.getElementById('participant-slider');
            const participantInput = document.getElementById('participant-input');
            const participantCountSpan = document.getElementById('participant-count');

            function calculateDynamicBudget(participantCount) {
                // Revert to fixed amounts: do not dynamically adjust T-shirt or Lunch costs.
                // Return a deep copy of the original budget data for safe UI mutation.
                return JSON.parse(JSON.stringify(originalBudgetData));
            }

            function updateDisplay(participantCount) {
                currentBudgetData = calculateDynamicBudget(participantCount);
                participantCountSpan.textContent = participantCount;

                const totalBudget = currentBudgetData.reduce((sum, item) => sum + item.cost, 0);
                const totalSpent = Object.values(expensesData).reduce((sum, amount) => sum + amount, 0);

                renderSummary(totalIncome, totalSpent, totalBudget);
                renderTable(currentBudgetData, expensesData);
            }

            function handleParticipantChange(event) {
                const newCount = parseInt(event.target.value, 10);
                if (isNaN(newCount) || newCount < 100 || newCount > 500) return;

                participantSlider.value = newCount;
                participantInput.value = newCount;

                updateDisplay(newCount);
            }

            Promise.all([
                fetch(budgetUrl).then(res => res.json()),
                fetch(expensesUrl).then(res => res.json()),
                fetch(incomeUrl).then(res => res.json())
            ]).then(([budgetData, expenses, incomeData]) => {
                // Store original budget data
                originalBudgetData = budgetData;

                // Process income
                totalIncome = incomeData.reduce((sum, item) => sum + item.amount, 0);

                // Process expenses by category
                expensesData = expenses.reduce((acc, expense) => {
                    acc[expense.type] = (acc[expense.type] || 0) + expense.amount;
                    return acc;
                }, {});

                // Initial display with default participant count
                updateDisplay(parseInt(participantInput.value, 10));

            }).catch(error => {
                console.error('Error fetching budget data:', error);
                document.getElementById('budget-table-body').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data. Please try again later.</td></tr>';
            });

            // Event listeners for participant calculator
            participantSlider.addEventListener('input', handleParticipantChange);
            participantInput.addEventListener('change', handleParticipantChange);

            function renderSummary(income, spent, budget) {
                const summaryContainer = document.getElementById('summary-cards');
                const balance = income - spent;
                const budgetRemaining = budget - spent;
                const toRaise = Math.max(0, budget - income);

                const cards = [
                    { title: 'Total Raised', value: income, isCurrency: true, color: 'positive' },
                    { title: 'Total Spent', value: spent, isCurrency: true, color: 'negative' },
                    { title: 'Fund Balance', value: balance, isCurrency: true, color: balance >= 0 ? 'positive' : 'negative' },
                    { title: 'Total Budget', value: budget, isCurrency: true, color: 'text-primary' },
                    { title: 'Budget Remaining', value: budgetRemaining, isCurrency: true, color: budgetRemaining >= 0 ? 'positive' : 'negative' },
                    { title: 'Funding Needed', value: toRaise, isCurrency: true, color: toRaise > 0 ? 'text-warning' : 'positive' }
                ];

                summaryContainer.innerHTML = cards.map(card => `
                    <div class="col-md">
                        <div class="card summary-card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title text-muted">${card.title}</h5>
                                <p class="display-6 ${card.color}">${card.isCurrency ? formatCurrency(card.value) : card.value}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function renderTable(budgetItems, expenses) {
                const tableBody = document.getElementById('budget-table-body');
                let tableContent = '';
                let totalBudgeted = 0;
                let totalSpent = 0;

                budgetItems.sort((a, b) => a.name_en.localeCompare(b.name_en)).forEach(item => {
                    const spent = expenses[item.name_en] || 0;
                    const remaining = item.cost - spent;
                    const percentage = item.cost > 0 ? (spent / item.cost) * 100 : 0;
                    const progressColor = getProgressBarColor(percentage);

                    totalBudgeted += item.cost;
                    totalSpent += spent;

                    tableContent += `
                        <tr>
                            <td>${item.name_en}</td>
                            <td>${formatCurrency(item.cost)}</td>
                            <td>${formatCurrency(spent)}</td>
                            <td class="${remaining < 0 ? 'negative' : ''}">${formatCurrency(remaining)}</td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar ${progressColor}" role="progressbar" style="width: ${percentage.toFixed(2)}%;" aria-valuenow="${percentage.toFixed(2)}" aria-valuemin="0" aria-valuemax="100">${percentage.toFixed(2)}%</div>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                tableBody.innerHTML = tableContent;

                // Render footer
                const tableFooter = document.getElementById('table-footer');
                const totalRemaining = totalBudgeted - totalSpent;
                tableFooter.innerHTML = `
                    <td><strong>Total</strong></td>
                    <td><strong>${formatCurrency(totalBudgeted)}</strong></td>
                    <td><strong>${formatCurrency(totalSpent)}</strong></td>
                    <td class="<strong>${totalRemaining < 0 ? 'negative' : ''}">${formatCurrency(totalRemaining)}</strong></td>
                    <td></td>
                `;
            }

            function getProgressBarColor(percentage) {
                // Keep >100% as strong danger. Use a purple-ish soft color for exactly 100%.
                if (percentage > 100) return 'bg-danger';
                // Allow a tiny tolerance for floating point calculations when matching 100%
                if (Math.abs(percentage - 100) < 1e-6) return 'bg-soft-overflow';
                if (percentage > 80) return 'bg-soft-warning';
                if (percentage > 50) return 'bg-soft-info';
                return 'bg-soft-success';
            }

            function formatCurrency(amount) {
                return `৳${amount.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            }

            // Sponsorship data loading
            const sponsorshipUrl = 'sponsorship-data.json';
            fetch(sponsorshipUrl)
                .then(response => response.json())
                .then(data => {
                    const received = data.filter(s => s.status === 'Received');
                    const approached = data.filter(s => s.status === 'Approached');
                    const toBeApproached = data.filter(s => s.status === 'To Be Approached');

                    document.getElementById('received-count').textContent = received.length;
                    document.getElementById('approached-count').textContent = approached.length;
                    document.getElementById('to-be-approached-count').textContent = toBeApproached.length;

                    document.getElementById('received-amount').textContent = `৳${sumSponsorshipAmounts(received).toLocaleString()}`;
                    document.getElementById('approached-amount').textContent = `৳${sumSponsorshipAmounts(approached).toLocaleString()}`;
                    document.getElementById('to-be-approached-amount').textContent = `৳${sumSponsorshipAmounts(toBeApproached).toLocaleString()}`;

                    const pending = [...approached, ...toBeApproached];
                    document.getElementById('pending-count').textContent = pending.length;
                    document.getElementById('pending-amount').textContent = `৳${sumSponsorshipAmounts(pending).toLocaleString()}`;

                    populateSponsorshipTable('received-table', received);
                    populateSponsorshipTable('approached-table', approached);
                    populateSponsorshipTable('to-be-approached-table', toBeApproached);
                })
                .catch(error => console.error('Error fetching sponsorship data:', error));

            function sumSponsorshipAmounts(data) {
                return data.reduce((sum, item) => sum + item.amount, 0);
            }

            function populateSponsorshipTable(tableId, data) {
                const tableBody = document.querySelector(`#${tableId} tbody`);
                tableBody.innerHTML = ''; // Clear existing data

                if (data.length === 0) {
                    const row = tableBody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 3;
                    cell.textContent = 'No sponsorships in this category.';
                    cell.style.textAlign = 'center';
                } else {
                    data.forEach(item => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = item.name;
                        row.insertCell().textContent = `৳${item.amount.toLocaleString()}`;
                        row.insertCell().textContent = item.liaison;
                    });
                }
            }
        });
    </script>
</body>
</html>
